// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String                 @id @default(uuid())
  email                 String                 @unique
  firstName             String?                @map("first_name")
  lastName              String?                @map("last_name")
  password              String?
  googleId              String?                @map("google_id")
  githubId              String?                @map("github_id")
  lastLoginAt           DateTime?              @map("last_login_at")
  createdAt             DateTime               @default(now()) @map("created_at")
  createdOrganizations  Organization[]         @relation("CreatedBy")
  organizationMembers   OrganizationMember[]   @relation("Member")
  invitedOrganizationMembers OrganizationMember[] @relation("InvitedBy")
  invitationsSent       Invitation[]           @relation("Inviter")
  invitationsAccepted   Invitation[]           @relation("AcceptedBy")
  chats                 Chat[]
  messages              Message[]
  refreshTokens         RefreshToken[]
  passwordResetTokens   PasswordResetToken[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  hashedToken String   @unique @map("hashed_token")
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  revoked     Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id          String   @id @default(uuid())
  hashedToken String   @unique @map("hashed_token")
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

model Organization {
  id                 String               @id @default(uuid())
  name               String
  createdAt          DateTime             @default(now()) @map("created_at")
  createdBy          User                 @relation("CreatedBy", fields: [createdById], references: [id])
  createdById        String               @map("created_by")
  organizationMembers OrganizationMember[]
  invitations        Invitation[]
  chats              Chat[]

  @@map("organizations")
}

model OrganizationMember {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String       @map("organization_id")
  user           User         @relation("Member", fields: [userId], references: [id])
  userId         String       @map("user_id")
  invitedBy      User?        @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedById    String?      @map("invited_by")
  invitedAt      DateTime?    @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  role           String
  isActive       Boolean      @map("is_active")

  @@map("organization_members")
}

model Invitation {
  id                String       @id @default(uuid())
  organization      Organization @relation(fields: [organizationId], references: [id])
  organizationId    String       @map("organization_id")
  email             String
  token             String       @unique
  inviter           User         @relation("Inviter", fields: [inviterUserId], references: [id])
  inviterUserId     String       @map("inviter_user_id")
  createdAt         DateTime     @default(now()) @map("created_at")
  expiredAt         DateTime     @map("expired_at")
  acceptedAt        DateTime?    @map("accepted_at")
  acceptedByUser    User?        @relation("AcceptedBy", fields: [acceptedByUserId], references: [id])
  acceptedByUserId  String?      @map("accepted_by_user_id")

  @@map("invitations")
}

model Chat {
  id             String       @id @default(uuid())
  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId String?      @map("organization_id")
  user           User         @relation(fields: [userId], references: [id])
  userId         String       @map("user_id")
  title          String
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  messages       Message[]

  @@map("chats")
}

model Message {
  id                String            @id @default(uuid())
  chat              Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId            String            @map("chat_id")
  user              User?             @relation(fields: [userId], references: [id])
  userId            String?           @map("user_id")
  role              String
  content           String
  createdAt         DateTime          @default(now()) @map("created_at")
  researchRequests  ResearchRequest[]

  @@map("messages")
}

model ResearchRequest {
  id             String           @id @default(uuid())
  message        Message          @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId      String           @map("message_id")
  status         String
  parameters     Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  researchResult ResearchResult[]

  @@map("research_requests")
}

model ResearchResult {
  id                String          @id @default(uuid())
  researchRequest   ResearchRequest @relation(fields: [researchRequestId], references: [id], onDelete: Cascade)
  researchRequestId String          @map("research_request_id")
  content           Json
  createdAt         DateTime        @default(now()) @map("created_at")

  @@map("research_results")
}
